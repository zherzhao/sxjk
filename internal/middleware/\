package middleware

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"regexp"
	"strings"
	"webconsole/global"
	"webconsole/internal/model"
	"webconsole/pkg/respcode"

	"github.com/gin-gonic/gin"
	"go.uber.org/zap"
)

func RecordRBAC(c *gin.Context) {
	role := c.GetString("userRole")
	infotype := c.GetString("infotype")

	permission := infotype + "-record"

	if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[permission], nil) {
		c.Next()
	} else {
		respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
		c.Abort()
	}
}

func QueryRBAC(c *gin.Context) {
	role := c.GetString("userRole")
	var permission string = "query-data"

	if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[permission], nil) {
		c.Next()
	} else {
		respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
		c.Abort()
	}
}

func IServerRBAC(p string) gin.HandlerFunc {
	return func(c *gin.Context) {
		role := c.GetString("userRole")
		permission := []string{"query-data", "query-datas"}

		if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[permission[1]], nil) {
			c.Next()

		} else if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[permission[0]], nil) {
			defer c.Abort()
			if c.Request.Method == "POST" {
				if p == "search" {
					search := new(model.IServerSearchReq)
					b, err := ioutil.ReadAll(c.Request.Body)
					if err != nil {
						return
					}

					regexp, err := regexp.Compile(`'(.*?)':`)
					index := regexp.FindAllIndex(b, 7)
					for _, r := range index {
						b[r[0]] = 34
						b[r[1]-2] = 34
					}
					log.Println(string(b))

					err := json.Unmarshal(b, search)
					log.Println(search, err)

					attr := search.QueryParameter.AttributeFilter
					if strings.HasPrefix(attr, "路线名称") {
						unit := c.GetString("userUnit")
						extra := fmt.Sprintf("交控单位名称 like '%s' and ", "%25"+unit+"%25")
						search.QueryParameter.AttributeFilter = extra + attr

					} else if strings.HasPrefix(attr, "桥梁名称") ||
						strings.HasPrefix(attr, "收费站名称") ||
						strings.HasPrefix(attr, "隧道名称") ||
						strings.HasPrefix(attr, "门架名称") {

						unit := c.GetString("userUnit")
						extra := fmt.Sprintf("所在地级市 like '%s' and ", "%25"+unit+"%25")
						search.QueryParameter.AttributeFilter = extra + attr

					} else if strings.HasPrefix(attr, "名称") {
						zap.L().Warn("没有权限")
						respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
						return
					} else {
						zap.L().Warn("小心sql注入")

					}
					//c.Request.Header.Set("Content-Length", fmt.Sprintf("%d", len(tmp)))
					//c.Request.Body = ioutil.NopCloser(bytes.NewReader([]byte(tmp)))

				} else if p == "query" {
					query := new(model.IServerQueryReq)
					b, err := ioutil.ReadAll(c.Request.Body)
					if err != nil {
						return
					}
					tmp := make([]byte, len(b))
					count := 0
					for i, v := range b {
						if v == 39 && count < 8 {
							tmp[i] = 34
							count++
							continue
						}
						tmp[i] = v
					}
					err = json.Unmarshal(tmp, query)
					if err != nil {
						return
					}
					attr := query.QueryParameter.AttributeFilter
					if strings.HasPrefix(attr, "路线名称") {
						unit := c.GetString("userUnit")
						extra := fmt.Sprintf("交控单位名称 like '%s' and ", "%25"+unit+"%25")
						query.QueryParameter.AttributeFilter = extra + attr

					} else if strings.HasPrefix(attr, "桥梁名称") ||
						strings.HasPrefix(attr, "收费站名称") ||
						strings.HasPrefix(attr, "隧道名称") ||
						strings.HasPrefix(attr, "门架名称") {

						unit := c.GetString("userUnit")
						extra := fmt.Sprintf("所在地级市 like '%s' and ", "%25"+unit+"%25")
						query.QueryParameter.AttributeFilter = extra + attr

					} else if strings.HasPrefix(attr, "名称") {
						zap.L().Warn("没有权限")
						respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
						return
					} else {
						zap.L().Warn("小心sql注入")

					}
					count = 0
					tmp, _ = json.Marshal(query)
					for i, v := range tmp {
						if v == 34 && count < 12 {
							if count%4 == 0 || count%4 == 1 || count == 10 || count == 11 {
								tmp[i] = 39
								count++
								continue
							}
							count++
						}
						tmp[i] = v
					}
					c.Request.Header.Set("Content-Length", fmt.Sprintf("%d", len(tmp)))
					c.Request.Body = ioutil.NopCloser(bytes.NewReader([]byte(tmp)))

				}
			}
			c.Next()

		} else {
			respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
			c.Abort()

		}
	}
}

func RoleRBAC(p string) gin.HandlerFunc {
	return func(c *gin.Context) {
		role := c.GetString("userRole")
		if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[p], nil) {
			c.Next()
		} else {
			respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
			c.Abort()
		}
	}
}

func UserRBAC(p string) gin.HandlerFunc {
	return func(c *gin.Context) {
		role := c.GetString("userRole")
		if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[p], nil) {
			c.Next()
		} else {
			respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
			c.Abort()
		}
	}
}

func TableRBAC(p string) gin.HandlerFunc {
	return func(c *gin.Context) {
		role := c.GetString("userRole")
		if global.Auth.RBAC.IsGranted(role, global.Auth.Permissions[p], nil) {
			c.Next()
		} else {
			respcode.ResponseError(c, respcode.CodeUserPermissionDenied)
			c.Abort()
		}
	}
}
